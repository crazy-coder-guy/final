<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
    <title>DelightX-Cart</title>
    <style>
        
        body {
        background-color: #ffffff;
        font-family:  "Montserrat", sans-serif;
    }
    .navbar-brand {
font-family: "Righteous", sans-serif !important;
}
    button.qty-btn {
    width: 30px; /* Fixed width for buttons */
    margin: 5px; /* No margin between buttons */
    background-color: green; /* Green background for buttons */
    color: white; /* White text for buttons */
    border: none; /* Remove default border */
    border-radius: 4px; /* Optional: rounded corners */
    transition: background-color 0.2s; /* Smooth transition */
}
button.qty-btn:hover {
    background-color: darkgreen; /* Darker green on hover */
}
button.qty-btn:active {
    background-color: darkgreen; /* Keep darker green on click */
}
button.qty-btn:disabled {
    background-color: #4a4848; /* Disabled button color */
    cursor: not-allowed; /* Change cursor style */
}
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-img-top {
            border-radius: 12px;
            object-fit: contain;
            height: 80px;
        }
        .total-price {
            font-size: 1rem;
            font-weight: bold;
            color: #007bff;
        }
        .delete-btn {
            cursor: pointer;
            color: red;
            font-size: 0.9rem;
        }
        .price-text {
            font-size: 0.9rem;
        }
        .bg-light-gray {
            background-color: #ffffff;
        }
        .section-title {
            font-weight: 600;
            color: #343a40;
        }
        .price-details {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 15px;
        }
        .discount-price, .total-amount {
            color: green;
            font-weight: bold;
        }
        .amount-value {
            color: rgb(0, 0, 0);
            font-weight: 600;
        }
        @media (max-width: 576px) {
            h2 {
                font-size: 1.5rem;
                text-align: center; /* Center title on mobile */
            }
            .total-price {
                font-size: 1rem;
            }
            .delete-btn {
                font-size: 1rem;
            }
            .card-img-top {
                height: 60px;
            }
            .price-details {
                padding: 10px; /* Adjust padding for mobile */
            }
            .scrollable-column {
                padding: 5px; /* Less padding for mobile */
            }
            .bottom-nav a {
                font-size: 14px; /* Smaller font size for mobile */
            }
        }
        @media (max-width: 768px) {
            .bottom-nav {
                display: flex;
                justify-content: space-around;
                align-items: center;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                background-color: #ffffff;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
                padding: 10px 0;
                z-index: 1000; /* Ensure the bottom nav appears above other content */
            }
            .bottom-nav a {
                font-size: 18px;
                color: #000;
                text-align: center;
                flex-grow: 1;
                text-decoration: none;
            }
            .desktop-nav {
                display: none;
            }
            .mobile-nav {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                background-color: #ffffff;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .nav-search {
                max-width: 60%;
            }
        }
        @media (min-width: 769px) {
            .bottom-nav {
                display: none;
            }
            .desktop-nav {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                background-color: #ffffff;
            }
            .nav-search {
                max-width: 500px;
            }
            .mobile-nav {
                display: none;
            }
        }
        .profile-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }
        .desktop-nav, .mobile-nav {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #ffffff;
        }
        .scrollable-column {
            max-height: 60vh; /* Adjust height as needed */
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px; /* Add some padding for better spacing */
        }
        .price-details {
            position: sticky;
            top: 0;
            background-color: #ffffff; /* Ensure background color for sticky */
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .pay-button {
            margin-bottom: 5%;
            font-size: 1rem; /* Larger font size */
            transition: background-color 0.3s; /* Smooth background color transition */
        }
        .pay-button:hover {
            background-color: #0056b3; /* Darker shade on hover */
        }
     /* Spinner Styles */
     .loader {
            width: 20px;
            aspect-ratio: 1;
            background: #25b09b;
            box-shadow: 0 0 60px 15px #25b09b;
            transform: translate(-80px);
            clip-path: inset(0);
            animation:
                l4-1 0.5s ease-in-out infinite alternate,
                l4-2 1s ease-in-out infinite;
        }
        @keyframes l4-1 {
            100% {transform: translateX(80px)}
        }
        @keyframes l4-2 {
            33% {clip-path: inset(0 0 0 -100px)}
            50% {clip-path: inset(0 0 0 0)}
            83% {clip-path: inset(0 -100px 0 0)}
        }
        #spinner {
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgb(255, 255, 255); /* Semi-transparent background */
        }
        .delivery-message {
    opacity: 0;
    transform: translateY(20px); /* Move it slightly down */
    transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; /* Smooth transition for both opacity and position */
    margin-bottom: 20px; /* Adjust the value as needed */
    visibility: hidden; /* Use visibility for better control */
}
.delivery-message.visible {
    opacity: 1;
    transform: translateY(0); /* Reset position */
    visibility: visible; /* Make it visible */
}
#totalDiscount {
    display: none; /* This hides the element */
}
.fade-in {
    opacity: 0;
    transition: opacity 0.2s ease-in;
}
.fade-in.show {
    opacity: 1;
}
.delivery-message {
    display: none; /* Initially hidden */
    opacity: 0;
    transition: opacity 0.10s ease-in;
}
.delivery-message.visible {
    opacity: 1; /* Fade in */
}
    </style>
</head>
<body>
<!-- Mobile Navbar -->
<nav class="navbar mobile-nav">
    <a class="navbar-brand" href="#">DelightX.</a>
</nav>
<!-- Desktop Navbar -->
<nav class="navbar desktop-nav">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">DelightX.</a>
        <form class="d-flex nav-search">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                    <i class="fas fa-search"></i>
                </span>
                <input type="search" class="form-control border-start-0" placeholder="Search for apples..." aria-label="Search" id="searchInputDesktop">
            </div>
        </form>
        <div class="d-flex align-items-center">
            <a href="cart.html" class="me-3"><i class="fas fa-shopping-cart fa-2"></i></a>
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png" alt="Profile" class="profile-img" id="profileImage">
        </div>
    </div>
</nav>
<div id="spinner">
    <div class="loader"></div>
</div>
<!-- Bottom Navbar for Mobile View -->
<nav class="bottom-nav">
    <a href="Home.html"><i class="fas fa-home"></i><br>Home</a>
    <a href="profile.html" id="profileLink"><img src="https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png" alt="Profile" class="profile-img" style="width: 24px; height: 24px;"><br>You</a>
    <a href="#"><i class="fas fa-ellipsis-h"></i><br>More</a>
    <a href="cart.html"><i class="fas fa-shopping-cart fa-2"></i><br>Cart</a>
</nav>
<div class="container mt-3">
    <h2 class="text-left mb-4 section-title">Shopping Cart</h2>
    <div class="row">
        <div class="col-lg-8 col-md-12 scrollable-column" id="cartItemsContainer">
            <div id="cartItems" class="row"></div>
            <img id="illustratorImage" src="src/undraw_empty_cart_co35.svg" alt="No items in cart" style="display: none; width: 100%; max-width: 400px; margin: auto;">
        </div>
        
        <div class="col-lg-4 col-md-12">
            <div class="price-details">
                <h5 class="text-center">
                    <i class="fa-solid fa-angle-up fa-bounce" id="scrollUpButton" style="cursor: pointer;"></i>
                </h5>                
                <h5 class="text-center">Price Details</h5>
                <div class="mb-3">
                    <strong>Total Amount:</strong> <span id="totalAmount" class="amount-value">0.00</span>
                </div>
                <div class="mb-3">
                    <strong>Delivery Charge:</strong> <span id="deliveryCharge">0.00</span>
                </div>
                <div class="mb-3">
                <span id="totalDiscount">0.00</span>
                </div>                
                <div class="mb-3">
                    <strong>You Save:</strong> <span id="totalSavings">0.00</span>
                </div>
                <div id="deliveryMessage" class="delivery-message mb-2" style="display: none;">
                    Your order will be delivered to your address by <span id="deliveryTime"></span>.
                </div>
                <div class="text-center mb-5">
                    <button id="payButton" class="btn btn-success btn-lg pay-button">Pay</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";
import { getDatabase, ref, get, remove, set, update } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js";
const firebaseConfig = {
    apiKey: "AIzaSyBjZDiWXkOclw7RmmU31822nPuj9px1hSA",
    authDomain: "quickbuy-29329.firebaseapp.com",
    projectId: "quickbuy-29329",
    storageBucket: "quickbuy-29329.appspot.com",
    messagingSenderId: "956510631625",
    appId: "1:956510631625:web:678411a2530ef065b97f18"
};
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const auth = getAuth(app);
let currentUserId = null;
onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUserId = user.uid;
        loadCartFromLocalStorage();
        fetchCart();
        // Default Gmail profile icon URL
        const gmailProfilePic = 'https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png'; 
        // Check local storage for user data
        const localStorageUserData = localStorage.getItem('userData');
        let userProfilePic;
        if (localStorageUserData) {
            const userData = JSON.parse(localStorageUserData);
            userProfilePic = userData.photo || gmailProfilePic; // Use local data if available
        } else {
            // Fetch user data from Firebase
            const userSnapshot = await get(ref(database, `users/${currentUserId}`));
            if (userSnapshot.exists()) {
                const userData = userSnapshot.val();
                userProfilePic = userData.photo || gmailProfilePic; // Fallback to Gmail logo if photo is not available
                
                // Store the fetched data in local storage
                localStorage.setItem('userData', JSON.stringify(userData));
            } else {
                // If user data doesn't exist, use Gmail logo
                userProfilePic = gmailProfilePic;
            }
        }
        const profileIconDesktop = document.getElementById('profileImage');
        const profileIconMobile = document.querySelector('#profileLink img');
        if (profileIconDesktop) {
            profileIconDesktop.src = userProfilePic;
            profileIconDesktop.alt = 'User  Profile Picture';
        }
        if (profileIconMobile) {
            profileIconMobile.src = userProfilePic;
            profileIconMobile.alt = 'User  Profile Picture';
        }
    } else {
        alert('You need to log in to view your cart.');
    }
});
async function fetchCart() {
    showSpinner();
    if (!currentUserId) return;
    const cartRef = ref(database, `carts/${currentUserId}`);
    const snapshot = await get(cartRef);
    hideSpinner();
    if (snapshot.exists()) {
        const cart = snapshot.val();
        storeCartInLocalStorage(cart);
        
        // Calculate total amount with delivery charge
        const totalAmount = calculateFinalAmountWithDelivery(cart);
        renderCart(cart, totalAmount);
    } else {
        console.log("No data available");
        renderCart({}, 0); // Render empty cart
    }
}
document.addEventListener("DOMContentLoaded", function () {
    const deliveryMessage = document.getElementById("deliveryMessage");
    const deliveryTime = document.getElementById("deliveryTime");
    function checkDeliveryTime() {
        const now = new Date();
        const hours = now.getHours();
        let delivery;
        if (hours >= 16) { // If time is 4 PM or later
            delivery = "tomorrow by 6 PM";
        } else {
            delivery = "today";
        }
        deliveryTime.textContent = delivery;
    }
    // Initial check for delivery time
    checkDeliveryTime();
    // Function to show the delivery message
function showDeliveryMessage() {
    setTimeout(() => {
        deliveryMessage.style.display = "block"; // Show message
        deliveryMessage.classList.add('visible'); // Add visible class for fade-in effect
    }, 2000); // Delay of 2 seconds
}
// Scroll effect
window.addEventListener('scroll', function () {
    const rect = deliveryMessage.getBoundingClientRect();
    const isVisible = rect.top <= window.innerHeight && rect.bottom >= 0;
    // Check if the delivery message is not yet displayed
    if (!isVisible && (rect.top <= window.innerHeight)) {
        showDeliveryMessage(); // Show message when user scrolls
    }
});
// Check if the delivery message is visible on page load
window.addEventListener('load', function () {
    const rect = deliveryMessage.getBoundingClientRect();
    // If it's already in the viewport
    if (rect.top <= window.innerHeight && rect.bottom >= 0) {
        showDeliveryMessage();
    }
});
});
function calculateFinalAmountWithDelivery(cart) {
    async function fetchCart() {
    showSpinner();
    if (!currentUserId) return;
    const cartRef = ref(database, `carts/${currentUserId}`);
    const snapshot = await get(cartRef);
    hideSpinner();
    if (snapshot.exists()) {
        const cart = snapshot.val();
        storeCartInLocalStorage(cart);
        
        // Calculate total amount with delivery charge
        const totalAmount = calculateFinalAmountWithDelivery(cart);
        renderCart(cart, totalAmount);
    } else {
        console.log("No data available");
        renderCart({}, 0); // Render empty cart
    }
}
function calculateFinalAmountWithDelivery(cart) {
    const deliveryCharge = 49;
    let total = 0;
    Object.values(cart).forEach(item => {
        total += parseFloat(item.finalPrice) * item.quantity;
    });
    return total + deliveryCharge; // Add delivery charge
}
    let total = 0;
    Object.values(cart).forEach(item => {
        total += parseFloat(item.finalPrice) * item.quantity;
    });
    return total; // Add delivery charge
}
function loadCartFromLocalStorage() {
    const cart = JSON.parse(localStorage.getItem(`cart_${currentUserId}`));
    if (cart) {
        console.log("Loaded cart from local storage:", cart);
        renderCart(cart);
    } else {
        console.log("No cart found in local storage.");
    }
}
function storeCartInLocalStorage(cart) {
    localStorage.setItem(`cart_${currentUserId}`, JSON.stringify(cart));
    console.log("Stored cart in local storage.");
}
document.getElementById('payButton').addEventListener('click', async () => {
    const uid = auth.currentUser.uid;
    const userRef = ref(database, `users/${uid}`);
    const userSnapshot = await get(userRef);
    // Check if user data exists
    if (!userSnapshot.exists()) {
        alert('Your profile is incomplete. Please update your address and mobile number.');
        window.location.href = 'User    - Profile.html'; 
        return;
    }
    const userData = userSnapshot.val();
    console.log('User    data:', userData); 
    // Check if user details are complete
    if (!userData.fullName || !userData.address || !userData.mobile) {
        alert('Please update your profile with your name, address, and mobile number.');
        window.location.href = 'profile.html'; 
        return;
    }
    const cartRef = ref(database, `carts/${uid}`);
    const snapshot = await get(cartRef);
    if (snapshot.exists()) {
        const cart = snapshot.val();
        // Check stock availability for each product in the cart
        const stockAvailability = await checkStockAvailability(cart);
        if (!stockAvailability) {
            alert(stockAvailability);
            return;
        }
        // Check if user selected quantity is greater than stock available
        const quantityCheck = await checkQuantity(cart);
        if (!quantityCheck) {
            alert('Sorry, the quantity you selected is greater than the stock available. Please try again later.');
            return;
        }
        // Calculate total amount including delivery charge
        const totalAmount = calculateFinalAmountWithDelivery(cart);
        // Prepare Razorpay payment options
        const options = {
            key: "rzp_test_XxEv4eXXqaPM4o", 
            amount: (totalAmount * 100).toFixed(0), 
            currency: "INR",
            name: "QuickBuy",
            description: "Your Order Description",
            handler: async function(response) {
                // Create order after successful payment
                await createOrder(cart);
                await removeAllCartItems();
                alert('Payment successful! Your cart has been cleared.');
            },
            prefill: {
                name: userData.fullName || "Customer Name",
                email: userData.email || "customer@example.com",
                contact: userData.mobile || "9999999999"
            },
            theme: {
                color: "#F37254"
            }
        };
        const razorpay = new Razorpay(options);
        razorpay.open();
    } else {
        alert('Your cart is empty.');
    }
});
async function removeAllCartItems() {
    const cartRef = ref(database, `carts/${currentUserId}`);
    try {
        await remove(cartRef);
        console.log('All items removed from cart.');
        localStorage.removeItem(`cart_${currentUserId}`);
        fetchCart();
    } catch (error) {
        console.error('Error removing cart items:', error);
    }
}
async function checkStockAvailability(cart) {
    for (const productId in cart) {
        const productRef = ref(database, `products/${productId}`);
        const snapshot = await get(productRef);
        if (snapshot.exists()) {
            const productData = snapshot.val();
            const currentStock = productData.stockAvailable;
            const quantityOrdered = cart[productId].quantity;
            if (currentStock < quantityOrdered) {
                return `Sorry, the product ${productId} is out of stock. Please try again later.`; 
            }
        } else {
            return `Sorry, the product ${productId} does not exist. Please try again later.`; 
        }
    }
    return true; 
}
async function checkQuantity(cart) {
    for (const productId in cart) {
        const productRef = ref(database, `products/${productId}`);
        const snapshot = await get(productRef);
        if (snapshot.exists()) {
            const productData = snapshot.val();
            const currentStock = productData.stockAvailable;
            const quantityOrdered = cart[productId].quantity;
            if (quantityOrdered > currentStock) {
                return false;
            }
        } else {
            return false;
        }
    }
    return true;
}
async function renderCart(cart) {
    const cartItemsContainer = document.getElementById('cartItems');
    const totalAmountElement = document.getElementById('totalAmount');
    const totalMRPElement = document.getElementById('totalMRP');
    const totalDiscountElement = document.getElementById('totalDiscount');
    const totalSavingsElement = document.getElementById('totalSavings');
    const deliveryChargeElement = document.getElementById('deliveryCharge');
    const illustratorImage = document.getElementById('illustratorImage');
    cartItemsContainer.innerHTML = '';
    // Check if the cart is empty
    if (!cart || Object.keys(cart).length === 0) {
        illustratorImage.style.display = 'block'; // Show the image
        totalAmountElement.innerHTML = '<span class="amount-value">₹0.00</span>';
        deliveryChargeElement.innerHTML = 'Free Delivery'; // Set delivery charge to "Free Delivery"
        return; // Exit the function if the cart is empty
    } else {
        illustratorImage.style.display = 'none'; // Hide the illustrator image if not empty
    }
    let totalAmount = 0;
    let totalMRP = 0;
    let totalDiscount = 0;
    Object.entries(cart).forEach(([key, item]) => {
        const col = document.createElement('div');
        col.className = 'col-12 mb-3 bg-light-gray';
        const row = document.createElement('div');
        row.className = 'row align-items-center';
        const imgCol = document.createElement('div');
        imgCol.className = 'col-3';
        const img = document.createElement('img');
        img.src = item.imageURL;
        img.className = 'card-img-top';
        imgCol.appendChild(img);
        row.appendChild(imgCol);
        const nameQtyCol = document.createElement('div');
        nameQtyCol.className = 'col-5';
        const title = document.createElement('h6');
        title.className = 'card-title mb-0';
        title.textContent = item.productName;
        nameQtyCol.appendChild(title);
        // Create quantity controls
        const qtyCol = document.createElement('div');
        qtyCol.className = 'qty-controls';
        const decrementBtn = document.createElement('button');
        decrementBtn.textContent = '-';
        decrementBtn.className = 'qty-btn';
        decrementBtn.addEventListener('click', () => {
            if (item.quantity > 1) {
                item.quantity--;
                updateQtyDisplay();
                updateCart(item, key); // Pass the current item and its key
            }
        });
        const qtyDisplay = document.createElement('span');
        qtyDisplay.className = 'qty-display';
        qtyDisplay.textContent = item.quantity;
        const incrementBtn = document.createElement('button');
        incrementBtn.textContent = '+';
        incrementBtn.className = 'qty-btn';
        incrementBtn.addEventListener('click', () => {
            if (item.quantity < Math.min(item.availableQuantity, 5)) {
                item.quantity++;
                updateQtyDisplay();
                updateCart(item, key); // Pass the current item and its key
            }
        });
        qtyCol.appendChild(decrementBtn);
        qtyCol.appendChild(qtyDisplay);
        qtyCol.appendChild(incrementBtn);
        qtyCol.appendChild(document.createTextNode(` ${item.availableQuantity} ${item.qtyUnit}`));
        nameQtyCol.appendChild(qtyCol);
        row.appendChild(nameQtyCol);
        const priceCol = document.createElement('div');
        priceCol.className = 'col-2';
        const finalPrice = document.createElement('p');
        finalPrice.className = 'price-text';
        finalPrice.innerHTML = `₹${(item.finalPrice * item.quantity).toFixed(2)}`;
        priceCol.appendChild(finalPrice);
        row.appendChild(priceCol);
        const deleteCol = document.createElement('div');
        deleteCol.className = 'col-2 text-center';
        const deleteBtn = document.createElement('span');
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.className = 'delete-btn';
        deleteBtn.addEventListener('click', () => {
            removeCartItem(key);
        });
        deleteCol.appendChild(deleteBtn);
        row.appendChild(deleteCol);
        col.appendChild(row);
        cartItemsContainer.appendChild(col);
        const itemQuantity = parseInt(item.quantity);
        const itemFinalPrice = parseFloat(item.finalPrice);
        const itemOriginalPrice = parseFloat(item.originalPrice);
        totalAmount += itemFinalPrice * itemQuantity;
        totalMRP += itemOriginalPrice * itemQuantity;
        totalDiscount += (itemOriginalPrice - itemFinalPrice) * itemQuantity;
        /// Check stock availability every second
        const productId = key;
        const productRef = ref(database, `products/${productId}`);
        const stockCheckInterval = setInterval(async () => {
            const snapshot = await get(productRef);
            if (snapshot.exists()) {
                const productData = snapshot.val();
                const currentStock = productData.stockAvailable;
                item.availableQuantity = currentStock; // Update item available quantity
                // Update visual elements based on available stock
                checkQuantityLimit();
                if (currentStock <= 0) {
                    // Update image to black and white if stock is 0
                    col.style.textDecoration = 'line-through';
                    img.style.filter = 'grayscale(100%)';
                    img.style.opacity = '0.5';
                    incrementBtn.disabled = true; // Disable increment if out of stock
                } else {
                    // Reset image if stock is available
                    img.style.filter = '';
                    img.style.opacity = '';
                }
                // Check quantity limit
                checkQuantityLimit();
            }
        }, 1000); // Check every second
        function updateQtyDisplay() {
            qtyDisplay.textContent = item.quantity;
            finalPrice.innerHTML = `₹${(item.finalPrice * item.quantity).toFixed(2)}`;
            if (item.quantity > item.availableQuantity) {
                col.style.textDecoration = 'line-through'; // Strike through if quantity exceeds stock
            } else {
                col.style.textDecoration = ''; // Remove strike through if quantity is valid
                img.style.filter = ''; // Reset image color
                img.style.opacity = '';
            }
        }
        function checkQuantityLimit() {
            if (item.quantity >= item.availableQuantity) {
                incrementBtn.disabled = true; // Disable increment button
                if (item.quantity > item.availableQuantity) {
                    col.style.textDecoration = 'line-through'; // Strike through if quantity exceeds stock
                }
            } else {
                incrementBtn.disabled = false; // Enable increment button
            }
        }
    });
    // Delivery charge logic
    const deliveryCharge = 49; // Delivery charge of 49
    const originalTotal = calculateTotalAmount(cart);
    // Update total amounts in the UI
    totalAmountElement.innerHTML = `<span class="amount-value"><span class="strike-through">₹${originalTotal.toFixed(2)}</span> ₹${totalAmount.toFixed(2)}</span>`;
    totalSavingsElement.innerHTML = `₹${totalDiscount.toFixed(2)}`;
    // Animate delivery charge display
    deliveryChargeElement.innerHTML = `<span class="strike-through" style="text-decoration: line-through;">₹${deliveryCharge}</span> Free Delivery!`;
    setTimeout(() => {
        deliveryChargeElement.classList.add('show-free-delivery');
    }, 1000); // Delay the animation
    // CSS for the animation and button styling
    const style = document.createElement('style');
    style.innerHTML = `
        .strike-through {
            animation: strikeThrough 1s forwards;
        }
        @keyframes strikeThrough {
            from {
                opacity: 1;
            }
            to {
                opacity: 0.5;
                text-decoration: line-through;
            }
        }
        .show-free-delivery {
            animation: fadeIn 1.5s forwards; /* Adjust duration as needed */
            color: green; /* Set text color to green */
        }
        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: translateX(-100%); /* Start from the left */
            }
            70% {
                opacity: 1;
                transform: translateX(0); /* Reach original position */
            }
            100% {
                opacity: 1; /* Keep it fully visible */
            }
        }
        .qty-btn {
            margin: 0 5px;
            padding: 2px 5px; /* Reduced padding for smaller size */
            cursor: pointer;
            font-size: 16px; /* Adjust font size */
            border: 1px solid #ccc; /* Add border for better visibility */
            border-radius: 4px; /* Rounded corners */
            background-color: #f0f0f0; /* Background color */
            transition: background-color 0.2s; /* Smooth transition */
        }
        .qty-btn:hover {
            background-color: #e0e0e0; /* Change color on hover */
        }
        .qty-btn:disabled {
            background-color: #ddd; /* Disabled button color */
            cursor: not-allowed; /* Change cursor style */
        }
    `;
    document.head.appendChild(style);
    function updateCart(item, key) {
    // Update Firebase with the current cart item
    const cartRef = ref(database, `carts/${currentUserId}/${key}`);
    const updatedItem = { quantity: item.quantity }; // Create an object with only the updated quantity
    // Use update to only modify the quantity field
    update(cartRef, updatedItem)
        .then(() => {
            console.log('Quantity updated successfully');
        })
        .catch((error) => {
            console.error('Error updating quantity:', error);
        });
    // Recalculate totals
    totalAmount = 0;
    totalMRP = 0;
    totalDiscount = 0;
    Object.values(cart).forEach(cartItem => {
        const itemQuantity = parseInt(cartItem.quantity);
        const itemFinalPrice = parseFloat(cartItem.finalPrice);
        const itemOriginalPrice = parseFloat(cartItem.originalPrice);
        totalAmount += itemFinalPrice * itemQuantity;
        totalMRP += itemOriginalPrice * itemQuantity;
        totalDiscount += (itemOriginalPrice - itemFinalPrice) * itemQuantity;
    });
    // Update total amounts in the UI
    totalAmountElement.innerHTML = `<span class="amount-value"><span class="strike-through">₹${calculateTotalAmount(cart).toFixed(2)}</span> ₹${totalAmount.toFixed(2)}</span>`;
    totalSavingsElement.innerHTML = `₹${totalDiscount.toFixed(2)}`;
}
}
async function removeCartItem(productId) {
    const cartRef = ref(database, `carts/${currentUserId}`);
    try {
        const snapshot = await get(cartRef);
        if (snapshot.exists()) {
            const cart = snapshot.val();
            delete cart[productId];
            await set(cartRef, cart);
            console.log('Item removed:', productId);
            storeCartInLocalStorage(cart);
            fetchCart();
        }
    } catch (error) {
        console.error('Error deleting item:', error);
    }
}

function getStoredLocation() {
    const storedData = localStorage.getItem("userLocation");
    if (storedData) {
        const locationData = JSON.parse(storedData);
        const currentTime = Date.now();

        if (currentTime - locationData.timestamp < 3600000) {
            return {
                latitude: locationData.latitude,
                longitude: locationData.longitude,
            };
        } else {
            localStorage.removeItem("userLocation");
        }
    }
    return null;
}

async function createOrder(cart) {
    const uid = auth.currentUser.uid;
    
    // Fetch user data to get the email and other details
    const userSnapshot = await get(ref(database, `users/${uid}`));
    const userData = userSnapshot.val();
    const userEmail = userData.email; 
    const userfullname = userData.fullName; 
    const userMobilenumber = userData.mobile;
    const userAddress = userData.address;  

    // Fetch user's location using the getStoredLocation function
    const userLocation = getStoredLocation();
    const userLat = userLocation ? userLocation.latitude : null;
    const userLng = userLocation ? userLocation.longitude : null;

    const orderId = `order_${uid}_${Date.now()}_${Math.floor(Math.random() * 10000)}`; 
    const orderData = {
        userName: userfullname,
        usermobilenumber: userMobilenumber,
        useraddress: userAddress,
        orderId: orderId,
        userId: uid,
        userEmail: userEmail, 
        items: cart,
        totalAmount: calculateTotalAmount(cart),
        orderDate: new Date().toISOString(),
        isNew: true, // Set isNew property to true
        latitude: userLat, // Store user's latitude
        longitude: userLng  // Store user's longitude
    };
    
    const ordersRef = ref(database, `orders/${uid}/${orderId}`);
    await set(ordersRef, orderData);
    console.log('Order created:', orderData);
    
    // Update stock availability for each product in the cart
    await updateStockAvailability(cart);
}

async function updateUserLocation(uid, latitude, longitude) {
    const userRef = ref(database, `users/${uid}`);
    await update(userRef, {
        location: {
            latitude: latitude,
            longitude: longitude
        }
    });
}

async function updateStockAvailability(cart) {
    for (const productId in cart) {
        const productRef = ref(database, `products/${productId}`);
        const snapshot = await get(productRef);
        if (snapshot.exists()) {
            const productData = snapshot.val();
            const currentStock = productData.stockAvailable;
            const quantityOrdered = cart[productId].quantity;
            if (currentStock >= quantityOrdered) {
                const newStock = currentStock - quantityOrdered;
                await update(productRef, { stockAvailable: newStock });
                console.log(`Updated stock for product ${productId}: ${newStock}`);
            } else {
                console.error(`Insufficient stock for product ${productId}`);
            }
        } else {
            console.error(`Product ${productId} not found`);
        }
    }
}
function calculateTotalAmount(cart) {
    let total = 0;
    Object.values(cart).forEach(item => {
        total += item.originalPrice * item.quantity;
    });
    return total;
}
// Hide the total discount element
document.getElementById('totalDiscount').style.display = 'none';
// You can still calculate and use totalDiscount in your logic
function calculateTotalDiscount(cart) {
    let totalDiscount = 0;
    Object.values(cart).forEach(item => {
        totalDiscount += item.discount * item.quantity; // Assuming `item.discount` is the discount per item
    });
    return totalDiscount;
}
document.getElementById('scrollUpButton').addEventListener('click', function() {
    // Scroll up by 100 pixels (adjust the value as needed)
    window.scrollBy({
        top: 1000, // Scroll up
        behavior: 'smooth' // Smooth scrolling
    });
});
function showSpinner() {
    const spinner = document.getElementById('spinner');
    spinner.style.display = 'block';
}
function hideSpinner() {
    const spinner = document.getElementById('spinner');
    spinner.style.display = 'none';
}
</script>
</body>
</html>
