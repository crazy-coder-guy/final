<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <title>DelightX Home</title>
</head>
<body>
   <div class="mobile-view"></div>
    <nav class="navbar mobile-nav">
        <a class="navbar-brand" href="#">DelightX.</a>
        <div class="nav-search-container">
            <form id="searchForm" class="d-flex nav-search">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-end-0 search-icon">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" id="searchInput" class="form-control modern-search" placeholder="Search for products..." />
                    <span id="closeSearch" class="close-icon" style="display: none;">&times;</span> <!-- Close button -->
                </div>
                <div id="suggestions" class="suggestions-container hidden"></div> <!-- Suggestions below the input -->
            </form>
        </div>
    </nav>
    
<!-- Desktop Navbar -->
<nav class="navbar desktop-nav">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">DelightX.</a>
        <form class="d-flex nav-search">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                    <i class="fas fa-search"></i>
                </span>
                <input type="search" class="form-control border-start-0" placeholder="Search for apples..." aria-label="Search" id="searchInputDesktop">
            </div>
        </form>
        <div class="d-flex align-items-center">
            <a href="cart.html" class="me-3"><i class="fas fa-shopping-cart fa-2"></i></a>
           <img src="https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png" alt="Profile" class="profile-img" id="profileImage">
        </div>
    </div>
</nav><!-- Bottom Navbar for Mobile View -->
<nav class="bottom-nav">
    <a href="#"><i class="fas fa-home"></i><br>Home</a>
    <a href="profile.html" id="profileLink"><img src="https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png" alt="Profile" class="profile-img" style="width: 24px; height: 24px;"><br>You</a>
    <a href="#"><i class="fas fa-ellipsis-h"></i><br>More</a>
    <a href="cart.html"><i class="fas fa-shopping-cart fa-2"></i><br>Cart</a>
</nav>

<div id="spinner" class="spinner-container">
    <div class="loader"></div>
</div>

<div class="category mt-1">
    <h2 class="text-center mb-4">Categories</h2>
    <div class="row g-1">
        <!-- Snacks and Savories -->
        <div class="col-4 mb-2 custom-margin">
            <a href="#" class="category-link" onclick="toggleSubcategories(1); return false;">
                <img src="Images/img3.png" class="img-fluid category-img" alt="Snacks and Savories" />
                <div class="text-center category-name">Snacks and Sweets</div>
            </a>
        </div>
        <!-- Cooking Essentials -->
        <div class="col-4 mb-2 custom-margin">
            <a href="#" class="category-link" onclick="toggleSubcategories(2); return false;">
                <img src="Images/img4.png" class="img-fluid category-img" alt="Cooking Essentials" />
                <div class="text-center category-name">Cooking Essentials</div>
            </a>
        </div>
        <!-- Personal Care -->
        <div class="col-4 mb-2 custom-margin">
            <a href="#" class="category-link" onclick="toggleSubcategories(3); return false;">
                <img src="Images/img5.png" class="img-fluid category-img" alt="Personal Care" />
                <div class="text-center category-name">Personal Care</div>
            </a>
        </div>
    </div>
    
    <div class="row g-1">
        <!-- Dairy Products -->
        <div class="col-4 mb-2 custom-margin">
            <a href="#" class="category-link" onclick="toggleSubcategories(4); return false;">
                <img src="Images/img6.png" alt="Dairy Products" />
                <div class="text-center category-name">Dairy Products</div>
            </a>
        </div>
        <!-- Beverages -->
        <div class="col-4 mb-2 custom-margin">
            <a href="#" class="category-link" onclick="toggleSubcategories(5); return false;">
                <img src="Images/img7.png" class="img-fluid category-img" alt="Beverages" />
                <div class="text-center category-name">Beverages</div>
            </a>
        </div>
        <!-- Household Items -->
        <div class="col-4 mb-2 custom-margin">
            <a href="#" class="category-link" onclick="toggleSubcategories(6); return false;">
                <img src="Images/img8.png" class="img-fluid category-img" alt="Household Items" />
                <div class="text-center category-name">Household Items</div>
            </a>
        </div>
    </div>
    
   <!-- Subcategories Rows -->
<div class="subcategories-row" id="row-1" style="display: none;">
    <div class="subcategories">
        <a href="#Chips" onclick="scrollToSubcategory('Chips'); return false;">
            <img src="https://e7.pngegg.com/pngimages/1006/382/png-clipart-lay-s-potato-chip-frito-lay-sour-cream-onion-onion.png" class="img-fluid subcategory-img" alt="Chips" />
            <div class="text-center">Crunchies</div>
        </a>
        <a href="#Namkeen" onclick="scrollToSubcategory('Namkeen'); return false;">
            <img src="https://thumbs.dreamstime.com/b/close-up-spicy-ratlami-mixture-indian-namkeen-snacks-ceramic-black-bowl-close-up-spicy-ratlami-mixture-indian-namkeen-214356686.jpg" class="img-fluid subcategory-img" alt="Namkeen" />
            <div class="text-center">Namkeen</div>
        </a>
        <a href="#Biscuits" onclick="scrollToSubcategory('Biscuits'); return false;">
            <img src="https://www.bigbasket.com/media/uploads/p/xl/40025066_11-britannia-milk-bikis-biscuits.jpg" class="img-fluid subcategory-img" alt="Biscuits" />
            <div class="text-center">Biscuits</div>
        </a>
        <a href="#Sweets" onclick="scrollToSubcategory('Sweets'); return false;">
            <img src="https://international.haldiram.com/assets/images/products/kaju_katli.png" class="img-fluid subcategory-img" alt="Sweets" />
            <div class="text-center">Sweets</div>
        </a>
        <a href="#Chocolate" onclick="scrollToSubcategory('Chocolate'); return false;">
            <img src="https://m.media-amazon.com/images/I/71w7ppkACUL.jpg" class="img-fluid subcategory-img" alt="Chocolate" />
            <div class="text-center">Chocolate</div>
        </a>
        <a href="#Cookies" onclick="scrollToSubcategory('Cookies'); return false;">
            <img src="https://www.quickpantry.in/cdn/shop/products/britannia-nutri-choice-hi-fibre-digestive-biscuits-100-g-quick-pantry_500x500.jpg?v=1710538222" class="img-fluid subcategory-img" alt="Cookies" />
            <div class="text-center">Cookies</div>
        </a>
        <a href="#GranolaBars" onclick="scrollToSubcategory('GranolaBars'); return false;">
            <img src="https://images.kglobalservices.com/www.kelloggs.in/en_in/product/product_896081/prod_img-940110_in_08901499010520_2202030336_p_1.png" class="img-fluid subcategory-img" alt="Granola Bars" />
            <div class="text-center">Granola Bars</div>
        </a>
    </div>    
</div>

    <div class="subcategories-row" id="row-2" style="display: none;">
        <div class="subcategories">
            <a href="#Essential Oils" onclick="scrollToSubcategory('EssentialOils'); return false;">
                <img src="https://www.groocy.in/storage/app/public/product/2023-10-31-6540f465cb126.png" class="img-fluid subcategory-img" alt="Cooking Oils" />
                <div class="text-center">Essential Oils</div>
            </a>
            <a href="#Spices and Seasonings" onclick="scrollToSubcategory('SpicesandSeasonings'); return false;">
                <img src="https://5.imimg.com/data5/SELLER/Default/2022/4/GZ/CD/PZ/140245462/90000486-500x500.jpg" class="img-fluid subcategory-img" alt="Spices and Seasonings" />
                <div class="text-center">Spices and Seasonings</div>
            </a>
           
            <a href="#Sauces" onclick="scrollToSubcategory('Sauces'); return false;">
                <img src="https://www.maltaproducts.com/wp-content/uploads/2020/08/ketchup-mayo.jpg" class="img-fluid subcategory-img" alt="Condiments and Sauces" />
                <div class="text-center">Sauces</div>
            </a>
            <a href="#Pasta and Noodles" onclick="scrollToSubcategory('PastaandNoodles'); return false;">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTRHVWvZcNJpaVaIHVEU4vVF4VmS72OtkrBFA&s" class="img-fluid subcategory-img" alt="Pasta and Noodles" />
                <div class="text-center">Pasta and Noodles</div>
            </a>
            <a href="#Rice" onclick="scrollToSubcategory('Rice'); return false;">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ1Bov-Act8X2_4r07TqOqXyeCRvm-sjGBrlg&s" class="img-fluid subcategory-img" alt="Rice and Grains" />
                <div class="text-center">Rice and Grains</div>
            </a>
            
        </div>
    </div>

    <div class="subcategories-row" id="row-3" style="display: none;">
        <div class="subcategories">
            <a href="#Skincare" onclick="scrollToSubcategory('Skincare'); return false;">
                <img src="https://assets.ajio.com/medias/sys_master/root/20231220/fQ02/6582db7bafa4cf41f5ddad23/-473Wx593H-4900526950-multi-MODEL.jpg" class="img-fluid subcategory-img" alt="Skincare" />
                <div class="text-center">Skincare</div>
            </a>
            <a href="#HairCare" onclick="scrollToSubcategory('HairCare'); return false;">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQJ1QNkwKmmKbTydS5PBeHjjnCdjhKlSqw6Aw&s" class="img-fluid subcategory-img" alt="Hair Care" />
                <div class="text-center">Hair Care</div>
            </a>
            <a href="#OralCare" onclick="scrollToSubcategory('OralCare'); return false;">
                <img src="https://homedelivery.ramachandran.in/media/catalog/product/cache/04c5c5c4276fe9dba74400abc896c29c/4/2/421420A001152.png" class="img-fluid subcategory-img" alt="Oral Care" />
                <div class="text-center">Oral Care</div>
            </a>
            <a href="#BathandBody" onclick="scrollToSubcategory('BathandBody'); return false;">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRahVb2z5gktd3qWzQ9QJ3AAhOMofb62moTPw&s" class="img-fluid subcategory-img" alt="Bath and Body" />
                <div class="text-center">Bath and Body</div>
            </a>
            <a href="#Fragrances" onclick="scrollToSubcategory('Fragrances'); return false;">
                <img src="https://d91ztqmtx7u1k.cloudfront.net/ClientContent/Images/Catalogue/unisex-fogg-perfumes-for-perso-20240607093212914.jpg" class="img-fluid subcategory-img" alt="Fragrances" />
                <div class="text-center">Fragrances</div>
            </a>
            <a href="#FeminineHygiene" onclick="scrollToSubcategory('FeminineHygiene'); return false;">
                <img src="https://5.imimg.com/data5/SELLER/Default/2022/3/AS/UX/PD/8901635/feminine-hygiene-products-500x500.jpg" class="img-fluid subcategory-img" alt="Feminine Hygiene" />
                <div class="text-center">Feminine Hygiene</div>
            </a>
        </div>
    </div>

    <div class="subcategories-row" id="row-4" style="display: none;">
        <div class="subcategories">
            <a href="#Ghee" onclick="scrollToSubcategory('Ghee'); return false;">
                <img src="https://m.media-amazon.com/images/I/61mPZ+NiXXL.jpg" class="img-fluid subcategory-img" alt="Dairy Alternatives" />
                <div class="text-center">Ghee</div>
            </a>
            <a href="#Cheese" onclick="scrollToSubcategory('Cheese'); return false;">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTVfhJ9exuRHRsWWu7lsx2IpylUXxqAoGUk7w&s" class="img-fluid subcategory-img" alt="Cheese" />
                <div class="text-center">Cheese</div>
            </a>
            
            <a href="#Butter" onclick="scrollToSubcategory('Butter'); return false;">
                <img src="https://5.imimg.com/data5/SELLER/Default/2023/5/312285703/EM/NO/LE/24906100/salted-hatsun-pasteurised-table-butter-500x500.png" class="img-fluid subcategory-img" alt="Butter and Margarine" />
                <div class="text-center">Butter</div>
            </a>
            <a href="#DairyAlternatives" onclick="scrollToSubcategory('DairyAlternatives'); return false;">
                <img src="https://m.media-amazon.com/images/I/61-rFN55fHL.jpg" class="img-fluid subcategory-img" alt="Dairy Alternatives" />
                <div class="text-center">others</div>
            </a>
          
        </div>
    </div>
    

    <div class="subcategories-row" id="row-5" style="display: none;">
        <div class="subcategories">
            <a href="#Tea and Coffee" onclick="scrollToSubcategory('TeaandCoffee'); return false;">
                <img src="https://m.media-amazon.com/images/I/51QF8woKr5S._AC_UF894,1000_QL80_.jpg" class="img-fluid subcategory-img" alt="Tea and Coffee" />
                <div class="text-center">Tea and Coffee</div>
            </a>
            <a href="#HealthDrinks" onclick="scrollToSubcategory('HealthDrinks'); return false;">
                <img src="https://m.media-amazon.com/images/I/71es8Fc+XyL.jpg" class="img-fluid subcategory-img" alt="Health Drinks" />
                <div class="text-center">Health Drinks</div>
            </a>
            <a href="#SoftDrinks" onclick="scrollToSubcategory('SoftDrinks'); return false;">
                <img src="https://backoffice.hipersuper.pt/app/uploads/2023/01/coca-cola.jpg" class="img-fluid subcategory-img" alt="Soft Drinks" />
                <div class="text-center">Soft Drinks</div>
            </a>
            <a href="#EnergyDrinks" onclick="scrollToSubcategory('EnergyDrinks'); return false;">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRigtYbsn15fW8XIMsaW42VaMC0Vr8Yb9YPdg&s" class="img-fluid subcategory-img" alt="Energy Drinks" />
                <div class="text-center">Energy Drinks</div>
            </a>
        </div>
    </div>
    

    <div class="subcategories-row" id="row-6" style="display: none;">
        <div class="subcategories">
            <a href="#Cleaning Supplies" onclick="scrollToSubcategory('CleaningSupplies'); return false;">
                <img src="https://m.media-amazon.com/images/I/71MXA1DlSkL.jpg" class="img-fluid subcategory-img" alt="Cleaning Supplies" />
                <div class="text-center">Cleaning Supplies</div>
            </a>
            <a href="#Kitchenware" onclick="scrollToSubcategory('Kitchenware'); return false;">
                <img src="https://m.media-amazon.com/images/I/61BLaDOomiL.jpg" class="img-fluid subcategory-img" alt="Kitchenware" />
                <div class="text-center">Kitchenware</div>
            </a>
            <a href="#Laundry Essentials" onclick="scrollToSubcategory('LaundryEssentials'); return false;">
                <img src="https://m.media-amazon.com/images/I/41ynMRBlm6L._AC_.jpg" class="img-fluid subcategory-img" alt="Laundry Essentials" />
                <div class="text-center">Laundry Essentials</div>
            </a>
        </div>
    </div>
</div>

<div class="offer-slider mt-1">
    <div class="offer-cards">
        <div class="offer-card">
            <img src="src/Launching.jpg" alt="Offer 1" />
        </div>
        <div class="offer-card">
            <img src="src/card2.jpg" alt="Offer 2" />
        </div>
        <div class="offer-card">
            <img src="src/CARD3.jpg" alt="Offer 3" />
        </div>
        <div class="offer-card">
            <img src="https://i2.wp.com/becleverwithyourcash.com/wp-content/uploads/2023/12/Supermarket_deals-24.jpg?resize=951%2C535&ssl=1" alt="Offer 4" />
        </div>
    </div>
    <div class="dots-container"></div>
</div>

<div class="container mt-1">
    <h2 class="text-center mb-4"></h2>
    <div id="productCategories" class="row"></div>
    <img id="illustratorImage" src="src/undraw_no_data_re_kwbl.svg" alt="No products available" style="display: none; width: 100%; max-width: 400px; margin: auto;">
</div>

<div class="ad-video-container">
    <video class="img-fluid ad-video" muted loop playsinline autoplay>
        <source src="src/Pringles’ Commercial _ Stop Motion Animation (HD).mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
</div>

<footer class="text-white text-center py-3">
        <div class="container">
            <p>© 2024 DelightX. | All Rights Reserved</p>
        </div>
    </footer>
</div>
<!-- FontAwesome CDN for Icons -->
  <!-- Owl Carousel CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css" />

  <!-- jQuery (necessary for Owl Carousel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- Owl Carousel JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>

<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script src="js/offer.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";
    import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js"; 

    const firebaseConfig = {
        apiKey: "AIzaSyBjZDiWXkOclw7RmmU31822nPuj9px1hSA",
        authDomain: "quickbuy-29329.firebaseapp.com",
        projectId: "quickbuy-29329",
        storageBucket: "quickbuy-29329.appspot.com",
        messagingSenderId: "956510631625",
        appId: "1:956510631625:web:678411a2530ef065b97f18"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);

    let allProducts = {};
    let currentUserUid = null;
    let cartItems = {};
    const defaultProfilePicUrl = "https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png";

    onAuthStateChanged(auth, async (user) => {
    showSpinner();
    const defaultProfilePicUrl = 'https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png'; // Default image URL

    if (user) {
        currentUserUid = user.uid;
        
        // Fetch user data from Firebase
        const userSnapshot = await get(ref(database, `users/${currentUserUid}`));
        
        if (userSnapshot.exists()) {
            const userData = userSnapshot.val();
            console.log(userData); // Check the data

            // Use user photo from Firebase, fallback to default
            const userProfilePicUrl = userData.photo || defaultProfilePicUrl;

            // Update the profile image
            const profileImageElement = document.getElementById('profileImage');
            if (profileImageElement) {
                profileImageElement.src = userProfilePicUrl;
            } else {
                console.error('Profile image element not found');
            }

            const profileLinkElement = document.getElementById('profileLink');
            if (profileLinkElement) {
                profileLinkElement.innerHTML = `<img src="${userProfilePicUrl}" alt="Profile" class="profile-img" style="width: 24px; height: 24px;"> <br> You`;
            } else {
                console.error('Profile link element not found');
            }

            // Update local storage with the profile picture URL
            localStorage.setItem('userProfilePic', userProfilePicUrl);
        } else {
            // Fallback if no user data found
            const profileImageElement = document.getElementById('profileImage');
            const profileLinkElement = document.getElementById('profileLink');

            if (profileImageElement) {
                profileImageElement.src = defaultProfilePicUrl;
            }

            if (profileLinkElement) {
                profileLinkElement.innerHTML = `<img src="${defaultProfilePicUrl}" alt="Profile" class="profile-img" style="width: 24px; height: 24px;"> <br> You`;
            }

            localStorage.setItem('userProfilePic', defaultProfilePicUrl); // Store default image
        }

        await fetchCartItems();
        hideSpinner();
        
        const storedCity = localStorage.getItem('userCity');
        if (storedCity) {
            fetchProductsForCity(storedCity);
        } else {
            showSpinner();
            getUserLocation().then(location => {
                hideSpinner();
                const { latitude, longitude } = location;
                getCityFromCoordinates(latitude, longitude).then(city => {
                    localStorage.setItem('userCity', city);
                    set(ref(database, `users/${currentUserUid}/location`), { city, latitude, longitude });
                    fetchProductsForLocation(latitude, longitude);
                });
            }).catch(error => {
                hideSpinner();
                console.error(error);
            });
        }
    } else {
        // User is not logged in
        const profileImageElement = document.getElementById('profileImage');
        const profileLinkElement = document.getElementById('profileLink');

        if (profileImageElement) {
            profileImageElement.src = defaultProfilePicUrl;
        }

        if (profileLinkElement) {
            profileLinkElement.innerHTML = `<img src="${defaultProfilePicUrl}" alt="Profile" class="profile-img" style="width: 24px; height: 24px;"> <br> You`;
        }

        localStorage.setItem('userProfilePic', defaultProfilePicUrl); // Store default image
    }

    hideSpinner(); // Ensure spinner is hidden after all operations
});

    window.addEventListener('beforeunload', () => {
        localStorage.removeItem('userCity'); // Remove user location from local storage
        if (currentUserUid) {
            set(ref(database, `users/${currentUserUid}/location`), null).catch(error => {
                console.error("Error removing location from Firebase:", error);
            }); // Remove location from Firebase
        }
    });
    
    function getUserLocation() {
  let hasShownError = false; // Flag to track if the error message has been shown
  return new Promise((resolve, reject) => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;

          const locationData = {
            latitude,
            longitude,
            timestamp: Date.now(),
          };
          localStorage.setItem("userLocation", JSON.stringify(locationData));
          resolve(locationData);
        },
        (error) => {
          const storedLocation = getStoredLocation();
          if (storedLocation) {
            resolve(storedLocation);
          } else {
            if (error.code === error.PERMISSION_DENIED) {
              if (!hasShownError) {
                hasShownError = true; // Set flag to true
                alert("Please turn on your location to show available products.");
                setTimeout(() => {
                  location.reload(); // Reload the page after 1 second
                }, 1000);
              }
              reject("Location access denied.");
            } else {
              if (!hasShownError) {
                hasShownError = true; // Set flag to true
                alert("Unable to retrieve your location. Please try again later.");
                setTimeout(() => {
                  location.reload(); // Reload the page after 1 second
                }, 1000);
              }
              reject("Unable to retrieve your location.");
            }
          }
        }
      );
    } else {
      alert("Geolocation is not supported by this browser.");
      reject("Geolocation is not supported by this browser.");
    }
  });
}

function getStoredLocation() {
  const storedData = localStorage.getItem("userLocation");
  if (storedData) {
    const locationData = JSON.parse(storedData);
    const currentTime = Date.now();

    if (currentTime - locationData.timestamp < 3600000) {
      return {
        latitude: locationData.latitude,
        longitude: locationData.longitude,
      };
    } else {
      localStorage.removeItem("userLocation");
    }
  }
  return null;
}

let previousLocation = null; 

setInterval(() => {
  getUserLocation()
    .then((location) => {
      if (
        !previousLocation || 
        (previousLocation && (previousLocation.latitude !== location.latitude || previousLocation.longitude !== location.longitude)) 
      ) {
        previousLocation = location; 
        location.reload(); 
      } 
    })
    .catch((error) => {
      console.error("Error getting location:", error);
    });
}, 1000);

async function getCityFromCoordinates(lat, lon) {
    const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
    const data = await response.json();
    return data.city || data.locality || "Unknown City";
}

async function fetchUserCity() {
    try {
        // Get the user's location
        const { latitude, longitude } = await getUserLocation();

        // Fetch the city name using the obtained coordinates
        const city = await getCityFromCoordinates(latitude, longitude);
        console.log(`User's city is: ${city}`);

        // Fetch products for the user's location
        await fetchProductsForLocation(latitude, longitude);
    } catch (error) {
        console.error(error);
    }
}

// Call the function to fetch the user's city
fetchUserCity();

async function fetchProductsForLocation(lat, lon) {
    showSpinner();
    const productsRef = ref(database, 'products');
    onValue(productsRef, snapshot => {
        hideSpinner();
        const products = snapshot.val() || {};
        const filteredProducts = [];

        for (const key in products) {
            const productLat = parseFloat(products[key].latitude); // Ensure latitude is a number
            const productLon = parseFloat(products[key].longitude); // Ensure longitude is a number
            const distance = calculateDistance(lat, lon, productLat, productLon);
            if (distance <= 80) { // Only show products within 10 km
                const product = {
                    id: key,
                    availability: products[key].availability,
                    category: products[key].category,
                    city: products[key].city,
                    finalPrice: products[key].finalPrice,
                    imageURL: products[key].imageURL,
                    listingPrice: products[key].listingPrice,
                    originalPrice: products[key].originalPrice,
                    productName: products[key].productName,
                    productType: products[key].productType,
                    qtyUnit: products[key].qtyUnit,
                    quantity: products[key].quantity,
                    stockAvailable: products[key].stockAvailable,
                    timestamp: products[key].timestamp,
                };
                filteredProducts.push(product);
            }
        }

        allProducts = groupProductsByCategory(filteredProducts);
        renderProducts(allProducts);
    });
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of the Earth in km
    const dLat = degreesToRadians(lat2 - lat1);
    const dLon = degreesToRadians(lon2 - lon1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(degreesToRadians(lat1)) * Math.cos(degreesToRadians(lat2)) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // Distance in km
}

function degreesToRadians(degrees) {
    return degrees * (Math.PI / 180);
}

function groupProductsByCategory(products) {
    return products.reduce((acc, product) => {
        const category = product.category || 'Others';
        if (!acc[category]) {
            acc[category] = [];
        }
        acc[category].push(product);
        return acc;
    }, {});
}


    async function fetchCartItems() {
    const localCart = JSON.parse(localStorage.getItem(`cart_${currentUserUid}`)) || {};
    
    if (Object.keys(localCart).length > 0) {
        // Load cart from local storage if available
        cartItems = localCart;
        console.log("Loaded cart from local storage:", cartItems);
    } else {
        // If local cart is empty, fetch from the database
        const cartRef = ref(database, `carts/${currentUserUid}`);
        const snapshot = await get(cartRef);
        
        if (snapshot.exists()) {
            // If cart exists in the database, load it
            cartItems = snapshot.val();
            console.log("Loaded cart from database:", cartItems);
        } else {
            // No cart found in both local storage and database
            cartItems = {};
            console.log("No cart found in local storage or database.");
        }
    }

    // Store the loaded cart items in local storage
    storeCartInLocalStorage(cartItems);
}

    function storeCartInLocalStorage(cart) {
        localStorage.setItem(`cart_${currentUserUid}`, JSON.stringify(cart));
        console.log("Stored cart in local storage.");
    }

    function renderProducts(products) {
    const categoriesContainer = document.getElementById('productCategories');
    categoriesContainer.innerHTML = ''; // Clear previous content

    const currentTime = new Date().getTime();

    for (const category in products) {
        // Create a category container
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'col-12 mb-4';

        // Create a category section heading
        const categoryTitle = document.createElement('h4');
        categoryTitle.className = 'text-left mb-4';
        categoryTitle.textContent = category;

        // Assign an ID to the category title for smooth scrolling
        categoryTitle.id = category.replace(/\s+/g, ''); // Remove spaces for the ID

        categoryDiv.appendChild(categoryTitle);

        // Create a product row for the current category
        const productRow = document.createElement('div');
        productRow.className = 'd-flex overflow-auto gap-3'; // Flexbox for horizontal scrolling

        products[category].forEach(product => {
            const productCol = document.createElement('div');
            productCol.className = 'col-auto'; // Make sure columns are auto-sized

            const productCard = document.createElement('div');
            productCard.className = 'card product-card';
            productCard.style.width = '200px'; // Fixed width for cards

            const productImage = document.createElement('img');
                productImage.src = product.imageURL;
                productImage.className = 'card-img-top';
                productCard.appendChild(productImage);

            const productBody = document.createElement('div');
            productBody.className = 'card-body text-left';

            const productName = document.createElement('h5');
            productName.className = 'card-title';
            productName.textContent = product.productName;
            productBody.appendChild(productName);

            const productLabel = document.createElement('span');
            productLabel.className = 'new-info mb-2';
            productLabel.textContent = product.productType;

            const productTimestamp = new Date(product.timestamp).getTime();
            const oneMinuteInMillis = 10 * 60 * 1000; 

            const timeDiff = currentTime - productTimestamp;

            // Show label only if product was listed within the last minute
            if (timeDiff < oneMinuteInMillis) {
                productBody.appendChild(productLabel);

                // Set a timeout to remove the product label after 1 minute
                setTimeout(() => {
                    productLabel.remove();
                }, oneMinuteInMillis - timeDiff); // Adjust timeout based on remaining time
            }

            const priceContainer = document.createElement('div');
            priceContainer.className = 'price-container mb-2';

            // Calculate discount percentage
            const originalPrice = parseFloat(product.originalPrice);
            const finalPrice = parseFloat(product.finalPrice);
            const discountAmount = originalPrice - finalPrice;

            const discountPercentage = Math.floor((originalPrice - finalPrice) / originalPrice * 100);

            const discountElement = document.createElement('span');
            discountElement.className = 'discount-amount text-success';
            discountElement.innerHTML = `<i class="fa-solid fa-arrow-up fa-fade"></i> ${discountPercentage}%`;

            const originalPriceElement = document.createElement('span');
            originalPriceElement.className = 'original-price';
            originalPriceElement.innerHTML = `₹${originalPrice.toFixed(2)}`;

            const finalPriceElement = document.createElement('span');
            finalPriceElement.className = 'final-price';
            finalPriceElement.innerHTML = `₹${finalPrice.toFixed(2)}`;

            priceContainer.appendChild(discountElement);
            priceContainer.appendChild(originalPriceElement);
            priceContainer.appendChild(finalPriceElement);
            productBody.appendChild(priceContainer);

            const qtyInfo = document.createElement('p');
            qtyInfo.className = 'qty-info';
            qtyInfo.textContent = `${product.quantity} ${product.qtyUnit}`; 
            productBody.appendChild(qtyInfo);

            // Quantity buttons
            const qtyContainer = document.createElement('div');
            qtyContainer.className = 'd-flex align-items-center qty-container mt-2';

            const qtyLabel = document.createElement('span');
            qtyLabel.textContent = 'QTY:';
            qtyLabel.className = 'me-2';

            const minusButton = document.createElement('button');
            minusButton.textContent = '-';
            minusButton.className = 'btn btn-secondary btn-sm';
            minusButton.onclick = () => {
                let currentQty = parseInt(qtyDisplay.textContent);
                if (currentQty > 1) { // Prevent going below 1
                    currentQty--;
                    qtyDisplay.textContent = currentQty;
                }
            };

            const qtyDisplay = document.createElement('span');
            qtyDisplay.textContent = '1'; // Start with 1 by default
            qtyDisplay.className = 'qty-display-container me-2';

            const plusButton = document.createElement('button');
            plusButton.textContent = '+';
            plusButton.className = 'btn btn-secondary btn-sm';
            plusButton.onclick = () => {
                let currentQty = parseInt(qtyDisplay.textContent);
 const maxQty = Math.min(5, product.stockAvailable);
                if (currentQty < maxQty) {
                    currentQty++;
                    qtyDisplay.textContent = currentQty;
                }
            };

            qtyContainer.appendChild(qtyLabel);
            qtyContainer.appendChild(minusButton);
            qtyContainer.appendChild(qtyDisplay);
            qtyContainer.appendChild(plusButton);
            productBody.appendChild(qtyContainer);

            const addToCartButton = document.createElement('button');
            addToCartButton.className = 'btn btn-primary w-100';
            addToCartButton.innerHTML = 'Add to Cart <i class="fa-solid fa-cart-shopping"></i>';
            addToCartButton.dataset.productId = product.id; // Add a data attribute to the button

            addToCartButton.addEventListener('click', () => {
                const quantity = qtyDisplay.textContent;
                if (parseInt(quantity) > 0) {
                    addToCart(product, quantity);
                    addToCartButton.innerHTML = '<i class="fa fa-spinner" aria-hidden="true"></i>';
                    addToCartButton.disabled = true;
                }
            });

            // Check if item is already in the cart
            if (cartItems[product.id]) {
                addToCartButton.className = 'btn add w-100';
                addToCartButton.innerHTML = '<i class="fa-solid fa-basket-shopping fa-bounce"></i> Already in Cart';
                addToCartButton.disabled = true;
            }

            productBody.appendChild(addToCartButton);
            productCard.appendChild(productBody);
            productCol.appendChild(productCard);
            productRow.appendChild(productCol);
        });

        categoryDiv.appendChild(productRow);
        categoriesContainer.appendChild(categoryDiv);
    }
}

async function addToCart(product, quantity) {
    const cartRef = ref(database, `carts/${currentUserUid}/${product.id}`);
    const cartItem = {
        productName: product.productName,
        finalPrice: product.finalPrice,
        quantity: parseInt(quantity),
        totalPrice: (product.finalPrice * quantity).toFixed(2),
        imageURL: product.imageURL,
        productType: product.productType,
        originalPrice: product.originalPrice,
        qtyUnit: product.qtyUnit,
        availableQuantity: product.quantity
    };

    await set(cartRef, cartItem);
    console.log('Product added to cart:', cartItem);

    // Update the add to cart button instead of re-rendering the entire products list
    const addToCartButton = document.querySelector(`[data-product-id="${product.id}"]`);
    addToCartButton.className = 'btn add w-100';
    addToCartButton.innerHTML = '<i class="fa-solid fa-basket-shopping fa-bounce"></i> Already in Cart';
    addToCartButton.disabled = true;

    cartItems[product.id] = cartItem; 
    storeCartInLocalStorage(cartItems); 
}

function filterProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase() || 
                       document.getElementById('searchInputDesktop').value.toLowerCase();
    console.log('Search Term:', searchTerm); // Debugging line
    const filteredProducts = {};
    const suggestions = [];

    for (const category in allProducts) {
        const productsInCategory = allProducts[category].filter(product => {
            const matches = product.productName.toLowerCase().includes(searchTerm);
            if (matches) {
                suggestions.push(product); // Add matching product to suggestions
            }
            return matches;
        });

        if (productsInCategory.length > 0) {
            filteredProducts[category] = productsInCategory;
        }
    }

    console.log('Filtered Products:', filteredProducts); // Debugging line
    renderProducts(filteredProducts);
    showSuggestions(suggestions); // Show suggestions
}
function showSuggestions(suggestions) {
    const suggestionsContainer = document.getElementById('suggestions');
    suggestionsContainer.innerHTML = ''; // Clear previous suggestions

    if (suggestions.length === 0) {
        suggestionsContainer.style.display = 'none'; // Hide if no suggestions
        return;
    }

    suggestions.forEach(product => {
        const item = document.createElement('div');
        item.className = 'suggestion-item';
        item.textContent = product.productName;

        // Optional: add click event to select product
        item.onclick = () => {
            document.getElementById('searchInput').value = product.productName;
            suggestionsContainer.style.display = 'none'; // Hide suggestions after selection
        };

        suggestionsContainer.appendChild(item);
    });

    suggestionsContainer.style.display = 'block'; // Show suggestions
}
document.getElementById('searchInput').addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault(); // Prevent form submission
        this.blur(); // Remove focus from the input, which will dismiss the keyboard

        const suggestionsContainer = document.getElementById('suggestions');
        suggestionsContainer.style.display = 'none'; // Hide suggestions on Enter
    }
});




document.getElementById('searchInput').addEventListener('input', filterProducts);
document.getElementById('searchInputDesktop').addEventListener('input', filterProducts);

// Prevent form submission when Enter is pressed
document.getElementById('searchForm').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevents page reload
    filterProducts(); // Call your filter function
});

function showSpinner() {
    document.getElementById('spinner').style.display = 'flex';
}

function hideSpinner() {
    document.getElementById('spinner').style.display = 'none';
}

// Function to calculate distance
function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of the Earth in km
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // Distance in km
}

function deg2rad(deg) {
    return deg * (Math.PI / 180);
}

// Function to fetch all user data from Firebase
async function getAllUsersData() {
    const usersRef = ref(database, 'users/');
    const snapshot = await get(usersRef);
    return snapshot.exists() ? snapshot.val() : null;
}
const style = document.createElement('style');
style.innerHTML += `
.suggestions-container {
    position: absolute;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #ccc;
    border-radius: 5px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    width: calc(100% - 20px);
    margin-top: 5px;
    display: none; /* Initially hidden */
}

.suggestion-item {
    padding: 10px;
    cursor: pointer;
}

.suggestion-item:hover {
    background: rgba(0, 128, 0, 0.1); /* Highlight on hover */
}
`;
document.head.appendChild(style);
const searchInput = document.getElementById('searchInput');
const closeSearch = document.getElementById('closeSearch');

searchInput.addEventListener('input', function() {
    // Show close button if there is input
    if (this.value) {
        closeSearch.style.display = 'block'; // Show the close button
    } else {
        closeSearch.style.display = 'none'; // Hide the close button
    }
});

closeSearch.addEventListener('click', function() {
    searchInput.value = ''; // Clear the input
    closeSearch.style.display = 'none'; // Hide the close button
    const suggestionsContainer = document.getElementById('suggestions');
    suggestionsContainer.style.display = 'none'; // Hide suggestions

    // Call function to reset filters and show all products
    showAllProducts();
});

function showAllProducts() {
    // Assuming allProducts is your complete product list
    renderProducts(allProducts); // Render all products
}

searchInput.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault(); // Prevent form submission
        this.blur(); // Remove focus from the input, which will dismiss the keyboard

        const suggestionsContainer = document.getElementById('suggestions');
        suggestionsContainer.style.display = 'none'; // Hide suggestions on Enter
    }
});
</script>
<script>
    const placeholders = ["Products", "Search for Snacks", "Beverages", "Bakery", "Personal Care"];
let currentIndex = 0;

function changePlaceholder() {
    const searchInput = document.getElementById('searchInput');
    searchInput.placeholder = placeholders[currentIndex];
    currentIndex = (currentIndex + 1) % placeholders.length; // Cycle through the array
}

// Change the placeholder every 2 seconds (2000 ms)
setInterval(changePlaceholder, 2000);

// Set the initial placeholder
changePlaceholder();

function scrollToCategory(category) {
  const categoryElement = document.getElementById(category);
  if (categoryElement) {
    // Calculate the top offset, considering fixed headers if any
    const headerHeight = document.querySelector('header')?.offsetHeight || 10; // Get header height
    const elementPosition = categoryElement.getBoundingClientRect().top + window.pageYOffset; // Get element position relative to the document

    // Calculate the final scroll position
    const scrollToPosition = elementPosition - headerHeight; // Adjust for header height

    window.scrollTo({
      top: scrollToPosition,
      behavior: "smooth",
    });
  } else {
    console.error(`Category section "${category}" not found.`);
  }
}


function toggleSubcategories(rowNumber) {
  // Hide the currently opened row if it's different from the clicked one
  if (currentlyOpenRow && currentlyOpenRow !== rowNumber) {
    document.getElementById(`row-${currentlyOpenRow}`).style.display = "none";
  }

  // Toggle the clicked row
  const targetRow = document.getElementById(`row-${rowNumber}`);
  if (targetRow) {
    targetRow.style.display = targetRow.style.display === "none" ? "block" : "none";
    currentlyOpenRow = targetRow.style.display === "none" ? null : rowNumber;
  }
}

function scrollToSubcategory(subcategoryId) {
  const element = document.getElementById(subcategoryId);
  if (element) {
    element.scrollIntoView({ behavior: "smooth", block: "center" }); // Center subcategory
  }
}

let currentlyOpenRow = null; 
    

function toggleSubcategories(rowNumber) {
    // Hide the currently opened row if it's different from the clicked one
    if (currentlyOpenRow && currentlyOpenRow !== rowNumber) {
        document.getElementById(`row-${currentlyOpenRow}`).style.display = 'none';
    }

    // Get the selected row
    const selectedRow = document.getElementById(`row-${rowNumber}`);

    // Toggle the selected row
    if (selectedRow.style.display === 'none') {
        selectedRow.style.display = 'block';
        currentlyOpenRow = rowNumber; // Update the currently open row
    } else {
        selectedRow.style.display = 'none'; // If already visible, hide it
        currentlyOpenRow = null; // Reset if closed
    }
}
</script>
</body>
</html>
